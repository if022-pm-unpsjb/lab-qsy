version: "3.8"

services:
  zookeeper:
    image: zookeeper:3.9
    container_name: zookeeper
    network_mode: "host"
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=0.0.0.0:2888:3888;2181
      ZOO_TICK_TIME: 2000
      ZOO_INIT_LIMIT: 10
      ZOO_SYNC_LIMIT: 5
    mem_limit: 512m
    memswap_limit: 512m

  ventas1:
    image: elixir:1.15.7-alpine
    container_name: ventas1
    network_mode: "host"
    volumes:
      - ./:/app
    working_dir: /app
    environment:
      MIX_HOME: /app/mix_home
      HEX_HOME: /app/hex_home
      SERVER_TO_RUN: Elixir.Libremarket.Ventas.Server
    command: elixir --sname ventas1 --cookie ${SECRET} -S mix run --no-halt --no-compile
    user: "${DOCKER_UID}:${DOCKER_GID}"
    depends_on:
      - zookeeper
    mem_limit: 512m
    memswap_limit: 512m

  ventas2:
    image: elixir:1.15.7-alpine
    container_name: ventas2
    network_mode: "host"
    volumes:
      - ./:/app
    working_dir: /app
    environment:
      MIX_HOME: /app/mix_home
      HEX_HOME: /app/hex_home
      SERVER_TO_RUN: Elixir.Libremarket.Ventas.Server
    command: elixir --sname ventas2 --cookie ${SECRET} -S mix run --no-halt --no-compile
    user: "${DOCKER_UID}:${DOCKER_GID}"
    depends_on:
      - zookeeper
    mem_limit: 512m
    memswap_limit: 512m

  compras1:
    image: elixir:1.15.7-alpine
    container_name: compras1
    network_mode: "host"
    volumes:
      - ./:/app
    working_dir: /app
    environment:
      MIX_HOME: /app/mix_home
      HEX_HOME: /app/hex_home
      SERVER_TO_RUN: Elixir.Libremarket.Compras.Server
    command: elixir --sname compras1 --cookie ${SECRET} -S mix run --no-halt --no-compile
    user: "${DOCKER_UID}:${DOCKER_GID}"
    depends_on:
      - zookeeper
    mem_limit: 512m
    memswap_limit: 512m

  compras2:
    image: elixir:1.15.7-alpine
    container_name: compras2
    network_mode: "host"
    volumes:
      - ./:/app
    working_dir: /app
    environment:
      MIX_HOME: /app/mix_home
      HEX_HOME: /app/hex_home
      SERVER_TO_RUN: Elixir.Libremarket.Compras.Server
    command: elixir --sname compras2 --cookie ${SECRET} -S mix run --no-halt --no-compile
    user: "${DOCKER_UID}:${DOCKER_GID}"
    depends_on:
      - zookeeper
    mem_limit: 512m
    memswap_limit: 512m

  pagos1:
    image: elixir:1.15.7-alpine
    container_name: pagos1
    network_mode: "host"
    volumes:
      - ./:/app
    working_dir: /app
    environment:
      MIX_HOME: /app/mix_home
      HEX_HOME: /app/hex_home
      SERVER_TO_RUN: Elixir.Libremarket.Pagos.Server
    command: elixir --sname pagos1 --cookie ${SECRET} -S mix run --no-halt --no-compile
    user: "${DOCKER_UID}:${DOCKER_GID}"
    depends_on:
      - zookeeper
    mem_limit: 512m
    memswap_limit: 512m

  pagos2:
    image: elixir:1.15.7-alpine
    container_name: pagos2
    network_mode: "host"
    volumes:
      - ./:/app
    working_dir: /app
    environment:
      MIX_HOME: /app/mix_home
      HEX_HOME: /app/hex_home
      SERVER_TO_RUN: Elixir.Libremarket.Pagos.Server
    command: elixir --sname pagos2 --cookie ${SECRET} -S mix run --no-halt --no-compile
    user: "${DOCKER_UID}:${DOCKER_GID}"
    depends_on:
      - zookeeper
    mem_limit: 512m
    memswap_limit: 512m

  envios1:
    image: elixir:1.15.7-alpine
    container_name: envios1
    network_mode: "host"
    volumes:
      - ./:/app
    working_dir: /app
    environment:
      MIX_HOME: /app/mix_home
      HEX_HOME: /app/hex_home
      SERVER_TO_RUN: Elixir.Libremarket.Envios.Server
    command: elixir --sname envios1 --cookie ${SECRET} -S mix run --no-halt --no-compile
    user: "${DOCKER_UID}:${DOCKER_GID}"
    depends_on:
      - zookeeper
    mem_limit: 512m
    memswap_limit: 512m

  envios2:
    image: elixir:1.15.7-alpine
    container_name: envios2
    network_mode: "host"
    volumes:
      - ./:/app
    working_dir: /app
    environment:
      MIX_HOME: /app/mix_home
      HEX_HOME: /app/hex_home
      SERVER_TO_RUN: Elixir.Libremarket.Envios.Server
    command: elixir --sname envios2 --cookie ${SECRET} -S mix run --no-halt --no-compile
    user: "${DOCKER_UID}:${DOCKER_GID}"
    depends_on:
      - zookeeper
    mem_limit: 512m
    memswap_limit: 512m

  # INFRACCIONES - NODO 1 (participa en elección de líder)
  infracciones1:
    image: elixir:1.15.7-alpine
    container_name: infracciones1
    network_mode: "host"
    volumes:
      - ./:/app
    working_dir: /app
    environment:
      MIX_HOME: /app/mix_home
      HEX_HOME: /app/hex_home
      SERVER_TO_RUN: Elixir.Libremarket.Infracciones.Server
    command: elixir --sname infracciones1 --cookie ${SECRET} -S mix run --no-halt --no-compile
    user: "${DOCKER_UID}:${DOCKER_GID}"
    depends_on:
      - zookeeper
    mem_limit: 512m
    memswap_limit: 512m

  # INFRACCIONES - NODO 2 (participa en elección de líder)
  infracciones2:
    image: elixir:1.15.7-alpine
    container_name: infracciones2
    network_mode: "host"
    volumes:
      - ./:/app
    working_dir: /app
    environment:
      MIX_HOME: /app/mix_home
      HEX_HOME: /app/hex_home
      SERVER_TO_RUN: Elixir.Libremarket.Infracciones.Server
    command: elixir --sname infracciones2 --cookie ${SECRET} -S mix run --no-halt --no-compile
    user: "${DOCKER_UID}:${DOCKER_GID}"
    depends_on:
      - zookeeper
    mem_limit: 512m
    memswap_limit: 512m

  # INFRACCIONES - NODO 3 (participa en elección de líder)
  infracciones3:
    image: elixir:1.15.7-alpine
    container_name: infracciones3
    network_mode: "host"
    volumes:
      - ./:/app
    working_dir: /app
    environment:
      MIX_HOME: /app/mix_home
      HEX_HOME: /app/hex_home
      SERVER_TO_RUN: Elixir.Libremarket.Infracciones.Server
    command: elixir --sname infracciones3 --cookie ${SECRET} -S mix run --no-halt --no-compile
    user: "${DOCKER_UID}:${DOCKER_GID}"
    depends_on:
      - zookeeper
    mem_limit: 512m
    memswap_limit: 512m

  rest:
    image: elixir:1.15.7-alpine
    container_name: rest
    network_mode: "host"
    volumes:
      - ./:/app
    working_dir: /app
    environment:
      MIX_HOME: /app/mix_home
      HEX_HOME: /app/hex_home
      SERVER_TO_RUN: Elixir.Libremarket.ServiceRest
    command: elixir --sname rest --cookie ${SECRET} -S mix run --no-halt --no-compile
    user: "${DOCKER_UID}:${DOCKER_GID}"
    mem_limit: 512m
    memswap_limit: 512m

  simulador:
    image: elixir:1.15.7-alpine
    container_name: simulador
    network_mode: "host"
    volumes:
      - ./:/app
    working_dir: /app
    environment:
      SERVER_TO_RUN: Elixir.Libremarket.Compras.Server
      MIX_HOME: /app/mix_home
      HEX_HOME: /app/hex_home
    command: elixir --sname simulador --cookie ${SECRET} -S mix run --no-halt --no-compile
    user: "${DOCKER_UID}:${DOCKER_GID}"
    profiles:
      - testing
    mem_limit: 512m
    memswap_limit: 512m